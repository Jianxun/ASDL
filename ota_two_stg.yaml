#───────────────────────────────────────────────────────────────────────────────
#  ASDL -- Two-Stage OTA (v2.3)
#      – modular bias-generation (vbn)
#      – consolidated stage-1 (tail + diff pair + PMOS mirror load)
#      – using "Patterned Instantiation" syntax
#      – cleaned for consistent M field
#───────────────────────────────────────────────────────────────────────────────

.version: "ASDL v1.0"
.top_module: ota

.defaults: &DEF
  NMOS: &NMOS {model: nmos_unit, B: VSS}
  PMOS: &PMOS {model: pmos_unit, B: VDD}
  CAP:  &CAP  {model: capacitor_unit}

modules:
  #────────────────────────  primitive building blocks  ──────────────────────#
  diff_pair_nmos:
    nets: {in_{p,n}: in, out_{p,n}: out, tail: io}
    parameters: {M: 2}
    circuits:
      - {<<: *NMOS, name: MN_{P,N}, S: tail, D: out_{p,n}, G: in_{p,n}, M: ${M}}
    notes:
      layout: "cross quad common centroid, use even number of M"

  current_mirror_pmos_1_1:
    nets: {ref: in, out: out, vdd: io}
    parameters: {M: 1}
    circuits:
      - {<<: *PMOS, name: MP_{ref,out}, S: vdd, D: {ref, out}, G: ref, M: ${M}}

  common_source_amp:
    nets: {in: in, out: out, vbn: in, vdd: io, vss: io}
    parameters: {M: 1}
    circuits:
      - {<<: *PMOS, name: MP_DRV,  S: vdd, D: out, G: in, M: ${M}}
      - {<<: *NMOS, name: MN_LOAD, S: vss, D: out, G: vbn, M: ${M}}

  #───────────────────────── 1. Bias-generation choices  ─────────────────────#
  bias_vbn_diode:
    nets: {iref: in, vbn: out, vss: io}
    parameters: {M: 1}
    circuits:
      - {<<: *NMOS, name: MN_bias, D: iref, S: vss, G: vbn, M: ${M}}
      - jumper: {name: J1, p1: iref, p2: vbn}
    notes:
      layout: "match all current source devices driven by vbn"

  #───────────────────────── 2. First gain stage  ────────────────────────────#
  ota_one_stage:
    nets: {
      in_{p,n}: in, vbn: in, out: out, vdd: io, vss: io,
      n_d: internal, # PMOS diode node
      n_tail: internal # diff pair tail node
    }
    parameters:
      M: {diff: 2, tail: 4, load: 2}
    circuits:

      diff: {model: diff_pair_nmos, M: ${M.diff},
             nets: {
               in_{p,n}: in_{p,n},
               out_{p,n}: {n_d, out},   # out_n → out
               tail: n_tail
             }}

      tail: {<<: *NMOS, name: MN_TAIL,
             D: n_tail, S: vss, G: vbn, M: ${M.tail}}

      load: {model: current_mirror_pmos_1_1,
             M: ${M.load},
             nets: {ref: n_d, out: out, vdd: vdd}}

  #───────────────────────── 3. Top-level OTA  ───────────────────────────────#
  ota:
    nets:
      {
        in_{p,n}: in,
        out: out,  # single-ended output
        iref: in,  # external bias current
        vdd: io, vss: io,
        stg1_out: internal # output of first gain stage
      }
    parameters:
      M: {
        diff: 4, tail: 8, load: 4, #stage1 sizing
        stage2: 8, #stage2 sizing
        bias_diode: 1 #bias diode sizing
      }
      Cc: 1pF

    circuits:

      #-- (A) bias generator
      vbn_gen: {model: bias_vbn_diode,
                M: ${M.bias_diode},
                nets: {iref: iref, vbn: vbn, vss: vss}}

      #-- (B) first gain stage
      stage1: {model: ota_one_stage,
               M: {diff: ${M.diff}, tail: ${M.tail}, load: ${M.load}},
               nets: {
                 in_{p,n}: in_{p,n},
                 vbn: vbn,
                 out: stg1_out,
                 vdd: vdd, vss: vss
               }}

      #-- (C) second gain / output stage
      stage2: {model: common_source_amp,
               M: ${M.stage2},
               nets: {
                 in: stg1_out, out: out,
                 vbn: vbn,
                 vdd: vdd, vss: vss
               }}

      #-- (D) Miller compensation
      Cc: {<<: *CAP, M: ${M.Cc}, p1: stg1_out, p2: out}

      #-- (E) back annotation dummy devices
      dummy_devices: {}

    notes:
      specs:
        - DC gain: 65dB
        - GBW: 100MHz
        - CMRR: 60dB
        - Offset: 2mV
        - HD3: -80dBc at 1V p-p output swing
        - Phase margin: 65 degrees
        - Power: minimize
      layout: 
        - symmetric horizontal layout
        - Deep n-well for the full ota. NTAP guard ring.
        - Horizontal M4 for VDD and VSS, sizing for < 1ohm resistance
        - back annotation dummy devices
      sizing:
        - 100uA nominal bias reference current
        - size stage 1 for noise performance
        - size stage 2 for load driving and linearity requirements
        - size miller cap to meet the phase margin specs
