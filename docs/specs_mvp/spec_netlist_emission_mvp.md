# Spec - Netlist Emission (ngspice) v0 (MVP)

## Purpose
Define MVP emission rules from ASDL_IFIR into ngspice-compatible netlists.

---

## MVP scope
- Target backend is ngspice.
- Only named connections (no positional conns).
- Subckt parameters are not supported.
- Device parameters are merged and rendered as `k=v` tokens.

---

## Top selection
- If `design.top` is set, emit that module.
- If `design.top` is absent and only one module exists, emit that module.
- If multiple modules exist and `design.top` is absent, emit an error diagnostic.

---

## Top wrapper handling
- Always emit the top module body.
- Default behavior: comment out the top module's `.subckt` and `.ends` lines.
  - Comment prefix is `*` at column 1.
- `--top-as-subckt`: keep the `.subckt` and `.ends` lines uncommented.

---

## Instance connection ordering
- If instance references a **module**: order nets by the referenced module's
  `port_order`.
- If instance references a **device**: order nets by the device's `ports`.
- Conns are named-only; no positional conns exist in IFIR.

---

## Device parameter rules

### Merge order (low -> high precedence)
1. `device.params` (defaults)
2. `device.backend.params` (backend overrides)
3. `instance.params` (instance overrides)

### Key restrictions
- `instance.params` must not introduce new keys.
- Any instance param key not present in `device.params` or
  `device.backend.params`:
  - emits a **warning** diagnostic, and
  - is ignored for emission.

### Deterministic parameter ordering
- Start with `device.params` order.
- Append any *new* keys from `device.backend.params` in backend order.
- Append any *new* keys from `instance.params` in instance order.
- Overriding a key does not change its position.

### Value representation
- All param values are raw strings in IFIR.
- Boolean values are stringified as `1`/`0` during AST -> NFIR conversion.

### Emission
- Render as space-joined `k=v` tokens (in deterministic order).
- If empty, emit no params and avoid extra whitespace.
- Template usage is explicit; there is no required params placeholder.

Example merge:
```
device.params:       w=1u  l=100n
backend.params:      m=2   l=120n
instance.params:     m=4   nf=2   (nf is invalid, warning + ignored)
result params:       w=1u l=120n m=4
```

---

## Template contract (devices)
- Each device backend supplies a `template` string.
- Supported placeholders:
  - `{name}` instance name
  - `{ports}` space-joined nets in port order (may be empty)
- `{params}` is deprecated; templates should not rely on it.
- Additional placeholders may be populated from backend `props`.

---

## ngspice module instantiation
- Use `X` instance prefix for module references:
  ```
  X<name> <conns> <subckt_name>
  ```
- Subckt parameters are not supported in MVP.

---

## System devices (ADR-0006)

### Purpose
System devices define backend-specific structural elements (subcircuit headers, footers, module calls) using the same template mechanism as regular device backends. This decouples backend syntax from emitter logic.

### Reserved names
System device names are prefixed with `__` and are reserved. Regular devices must not use these names.

### Required system devices
Every backend must define the following system devices in `backends.yaml`:

| System Device | Purpose | Required Placeholders | Optional Placeholders |
|---------------|---------|----------------------|----------------------|
| `__subckt_header__` | Non-top module header | `{name}` | `{ports}` |
| `__subckt_footer__` | Non-top module footer | `{name}` | - |
| `__top_header__` | Top module header | `{name}` | `{ports}` |
| `__top_footer__` | Top module footer | `{name}` | - |
| `__subckt_call__` | Module instantiation | `{name}`, `{ports}`, `{ref}` | - |

### Optional system devices
Backends may define these for file-level customization:

| System Device | Purpose | Placeholders |
|---------------|---------|--------------|
| `__netlist_header__` | File-level preamble | `{backend}`, `{top}` |
| `__netlist_footer__` | File-level postamble | `{backend}`, `{top}` |

### Backend configuration file
- Location: Determined by environment variable `ASDL_BACKEND_CONFIG`; defaults to `config/backends.yaml`
- Format: YAML with backend sections containing `system_devices` entries
- Example for ngspice:
  ```yaml
  ngspice:
    system_devices:
      __subckt_header__:
        template: ".subckt {name} {ports}"
      __subckt_footer__:
        template: ".ends {name}"
      __top_header__:
        template: "*.subckt {name} {ports}"
      __top_footer__:
        template: "*.ends {name}"
      __subckt_call__:
        template: "X{name} {ports} {ref}"
      __netlist_header__:
        template: "* Generated by ASDL"
      __netlist_footer__:
        template: ".end"
  ```

### Rendering rules
- System devices are rendered using `_render_system_device()` (similar to `_emit_instance()`)
- Placeholder validation applies (same as device backends)
- Whitespace collapsing applies when `{ports}` is empty
- Missing required system devices emit `MISSING_BACKEND` error and abort emission

### Top module handling
- If `is_top and not top_as_subckt`: use `__top_header__` and `__top_footer__`
- Otherwise: use `__subckt_header__` and `__subckt_footer__`
- This replaces the previous conditional commenting logic

### Module instantiation
- Module instances use `__subckt_call__` system device instead of hardcoded `X{name} {conns} {ref}` syntax
- Placeholder context:
  - `{name}`: instance name
  - `{ports}`: space-joined connection nets in port order
  - `{ref}`: referenced module name

### Validation
- Backend config is loaded and validated at emission time
- Missing required system devices: fatal error (`MISSING_BACKEND`)
- Malformed templates: fatal error (`MALFORMED_TEMPLATE`)
- Unknown placeholders in templates: fatal error (`UNKNOWN_REFERENCE`)

---

## Individual parameter placeholders (T-046)
After merging device/backend/instance params, each key-value pair is available as a template placeholder:
- Example: If merged params are `{L: "0.2u", W: "5u", NF: "2"}`, then `{L}`, `{W}`, `{NF}` are available in templates
- This allows templates like `template: "M{name} {ports} {model} L={L} W={W} NF={NF}"`
- Backward compatibility: `{params}` placeholder still available as formatted string `"L=0.2u W=5u NF=2"`
- Props override params if names collide
