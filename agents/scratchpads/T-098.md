# T-098: Atomize NFIR endpoints before IFIR inversion

## Task summary (DoD + verify)
- Update NFIR->IFIR conversion to atomize instances/nets/endpoints and build IFIR conns per atom so subset endpoint tokens (e.g., `MN_IN_<N>`) map to the correct atomized instance without producing duplicate ports.
- Preserve `pattern_origin` metadata for atomized names.
- Ensure PatternAtomizePass is idempotent or skips already-atomized IFIR.
- Update IFIR converter tests to expect atomized names and add coverage for subset endpoint bindings that would otherwise duplicate ports.
- Verify: `pytest tests/unit_tests/ir/test_ifir_converter.py tests/unit_tests/ir/test_pattern_atomization.py -v`

## Read
- agents/context/lessons.md
- agents/context/contract.md
- agents/context/tasks.yaml
- agents/context/tasks_state.yaml
- agents/context/project_status.md
- agents/adr/ADR-0013-nfir-atomized-ifir-inversion.md

## Plan
- Inspect NFIR->IFIR conversion for instance/net/endpoint handling and existing atomization helpers.
- Update IFIR converter tests to expect atomized names and cover subset endpoint bindings that would duplicate ports.
- Implement atomized NFIR inversion with `pattern_origin` metadata preservation.
- Make PatternAtomizePass idempotent or detect already-atomized IFIR.
- Run verification tests.

## Progress log
- Understanding: NFIR->IFIR should emit per-atom IFIR ops and per-atom conns so endpoint subsets bind only the intended atom; PatternAtomizePass should skip/avoid double expansion; tests should reflect atomized output.
- Todo:
  - [x] Update IFIR converter tests for atomized names + subset endpoint binding coverage.
  - [x] Update NFIR->IFIR conversion to atomize instances/nets/endpoints and preserve pattern_origin.
  - [x] Ensure PatternAtomizePass is idempotent or skips already-atomized IFIR.
  - [x] Run verification tests.

## Patch summary
- Atomized NFIR->IFIR inversion with per-atom conns and parameter expansion, plus converter test updates for atomized outputs and subset endpoints.
- Preserved `pattern_origin` during PatternAtomizePass idempotent runs with coverage for repeated atomization.

## PR URL
https://github.com/Jianxun/ASDL/pull/109
## Verification
- `./venv/bin/pytest tests/unit_tests/ir/test_ifir_converter.py tests/unit_tests/ir/test_pattern_atomization.py -v`

## Status request (Done / Blocked / In Progress)
Done

## Blockers / Questions

## Next steps
