# ADR-0006: System Devices for Backend Structural Templates

**Status**: Accepted
**Date**: 2026-01-04

---

## Context

The ngspice emitter (`src/asdl/emit/ngspice.py`) hardcodes backend-specific syntax for:

1. **Subcircuit delimiters**: `.subckt {name} {ports}` and `.ends {name}`
2. **Module instantiation**: `X{name} {conns} {ref}`
3. **Netlist file framing**: `.end` and any header comments

This tight coupling to ngspice syntax makes it difficult to:
- Support additional backends (spectre, hspice, etc.) without duplicating emitter logic
- Customize output format per backend
- Test structural template variations independently

Device instances already use a flexible template system (`backend.template`), which supports
backend-specific syntax cleanly. Structural elements should use the same mechanism.

---

## Decision

Introduce **system devices**: reserved device names prefixed with `__` that define backend-specific
structural elements. System devices are defined in an external backend configuration file
(`backends.yaml`) and use the same template placeholder mechanism as regular device backends.

### Required system devices

All backends must define these system devices:

| System Device | Purpose | Required Placeholders |
|---------------|---------|----------------------|
| `__subckt_header__` | Subcircuit header | `{name}` |
| `__subckt_footer__` | Subcircuit footer | `{name}` |
| `__subckt_call__` | Module instantiation | `{name}`, `{ports}`, `{ref}` |
| `__netlist_header__` | File-level preamble | (none) |
| `__netlist_footer__` | File-level postamble | (none) |

`{ports}` is optional for `__subckt_header__`. `__netlist_header__` and `__netlist_footer__` may be
empty templates, but the entries must exist.

### Backend configuration file

- Location: Determined by environment variable `ASDL_BACKEND_CONFIG`; defaults to
  `config/backends.yaml`
- Format: YAML with backend sections containing `system_devices` entries
- Example:
  ```yaml
  ngspice:
    system_devices:
      __subckt_header__:
        template: ".subckt {name} {ports}"
      __subckt_footer__:
        template: ".ends {name}"
      __subckt_call__:
        template: "X{name} {ports} {ref}"
      __netlist_header__:
        template: "* Generated by ASDL"
      __netlist_footer__:
        template: ".end"
  ```

### Top module handling

- If `top_as_subckt` is **true**, the top module is emitted using
  `__subckt_header__` and `__subckt_footer__` like any other subcircuit.
- If `top_as_subckt` is **false**, emit **no** subcircuit wrapper for the top module.

### Emitter changes

1. Load backend config at emission time
2. Validate that required system devices are present (fatal error if missing)
3. Replace hardcoded structural syntax with `_render_system_device()` calls
4. Remove `_format_subckt_line()` and inline header/footer string literals
5. Always render `__netlist_header__` and `__netlist_footer__` (empty templates emit no line)

---

## Consequences

### Positive

1. **Backend extensibility**: new backends can be added via configuration only
2. **Consistency**: all rendering uses the same template system
3. **Testability**: system device templates can be unit tested independently
4. **Separation of concerns**: backend syntax lives in config files, not in emitter code

### Negative

1. **Configuration burden**: every backend must define 5 required system devices
2. **Indirection**: structural syntax is no longer visible in emitter code
3. **Validation overhead**: missing system devices become runtime errors

---

## Alternatives Considered

### Alternative 1: Hardcoded fallbacks with backend overrides

Keep default templates in the emitter code; allow backends to override via config.

**Rejected because**: partial hardcoding defeats extensibility and retains ngspice assumptions.

### Alternative 2: Emitter subclasses per backend

Create `NgspiceEmitter`, `SpectreEmitter`, etc., each with custom logic.

**Rejected because**: code duplication and loss of shared template rendering.
