# Tasks

## Active OKR(s)
- See `agents/context/okrs.md`.

## Current Sprint
- None.

## Backlog
- T-050 | Status: Backlog | Owner: Executor | DoD: Make netlist CLI/e2e tests deterministic by writing a temporary backend config and setting `ASDL_BACKEND_CONFIG` in tests; ensure expected netlists align with the test templates and do not rely on repo `config/backends.yaml`. | Verify: `pytest tests/unit_tests/cli -v && pytest tests/unit_tests/e2e -v` | Links: scratchpad `agents/scratchpads/T-050_netlist_test_backend_config.md`.
- T-051 | Status: Backlog | Owner: Executor | DoD: Remove the requirement that backend device templates include `{name}`. Update template validation so pure-instruction templates are allowed, keep `{ports}` optional. Adjust diagnostics/tests to reflect the new rule. | Verify: `pytest tests/unit_tests/emit -v && pytest tests/unit_tests/netlist -v` | Links: scratchpad `agents/scratchpads/T-051_optional_name_placeholder.md`.
- T-052 | Status: Backlog | Owner: Executor | DoD: Refactor backend lowering to separate verification from rendering/emission; reduce overly defensive checks in render paths now covered by verification. Focus on readability and single-pass flow without changing netlist output or diagnostics semantics. | Verify: `pytest tests/unit_tests/emit -v && pytest tests/unit_tests/netlist -v` | Links: scratchpad `agents/scratchpads/T-052_backend_lowering_refactor.md`.
- T-053 | Status: Backlog | Owner: Executor | DoD: Preserve raw pattern tokens verbatim in AST/NFIR/IFIR (no basename+pattern decomposition). Update parsers/converters to retain the original token strings; add tests to ensure round-trip preservation through NFIR/IFIR. | Verify: `pytest tests/unit_tests/ast -v && pytest tests/unit_tests/ir -v` | Links: scratchpad `agents/scratchpads/T-053_pattern_expansion.md`.
- T-057 | Status: Backlog | Owner: Executor | DoD: Implement a standalone pattern expansion engine per `docs/specs/spec_asdl_pattern_expansion.md` (ranges, alternation, splicing, expansion order, collisions, errors). Use `_` between basename and suffixes. Add focused unit tests for expansion and diagnostics; no pipeline integration yet. | Verify: `pytest tests/unit_tests/parser -v` | Links: scratchpad `agents/scratchpads/T-057_pattern_expansion_engine.md`.
- T-058 | Status: Backlog | Owner: Executor | DoD: Implement pattern binding verification for nets/endpoints: total length comparison, scalar net broadcast, patterned net requires all endpoint lengths match. Emit diagnostics on mismatch and malformed patterns. Add unit tests in IR layer. | Verify: `pytest tests/unit_tests/ir -v` | Links: scratchpad `agents/scratchpads/T-058_pattern_binding_verification.md`.
- T-059 | Status: Backlog | Owner: Executor | DoD: Add an elaboration pass that expands pattern tokens into explicit names/endpoints before backend emission. Wire it into the pipeline before IFIR->emit; add tests covering expansion + netlist output stability. | Verify: `pytest tests/unit_tests/ir -v && pytest tests/unit_tests/netlist -v` | Links: scratchpad `agents/scratchpads/T-059_pattern_elaboration_pass.md`.
- T-060 | Status: Backlog | Owner: Executor | DoD: Add a CLI command `asdlc schema` that writes the JSON schema and text schema to an output directory (default: CWD), reusing the same generator logic as `scripts/generate_schema.py`. Update CLI help to list the new command and add CLI tests that assert the output files are created. | Verify: `pytest tests/unit_tests/cli -v` | Links: scratchpad `agents/scratchpads/T-060_cli_schema_command.md`.
- T-061 | Status: Backlog | Owner: Executor | DoD: Extend the AST schema to allow a top-level `imports: Dict[str, str]` mapping (namespace -> path) per `docs/specs/spec_asdl_import.md`; update Pydantic models, parser validation/diagnostics, and `scripts/generate_schema.py` output. Update `docs/specs/spec_ast.md` to include `imports` (keep MVP spec unchanged). Add parser/AST tests for valid and invalid `imports` (bad namespace, duplicate key, invalid type). | Verify: `pytest tests/unit_tests/parser -v && pytest tests/unit_tests/ast -v` | Links: scratchpad `agents/scratchpads/T-061_ast_imports_schema.md`.
- T-062 | Status: Backlog | Owner: Executor | DoD: Implement import resolution + file loading per `docs/specs/spec_asdl_import.md` (relative/absolute/logical roots, no extension inference, `--lib` name ignored for resolution, path normalization collapses `.`/`..`, no symlink resolution). Build a `ProgramDB` keyed by `file_id` (absolute path) and a per-file `NameEnv` that allows multiple namespaces to the same file. Detect cycles with a readable import chain and emit diagnostics for missing files and malformed paths. Add unit tests for resolution order, cycles, and missing imports. | Verify: `pytest tests/unit_tests/parser -v && pytest tests/unit_tests/ir -v` | Links: scratchpad `agents/scratchpads/T-062_import_resolution.md`.
- T-063 | Status: Backlog | Owner: Executor | DoD: Wire import-aware name resolution into AST->NFIR conversion: allow unqualified symbols only from the current file, and `ns.symbol` for imported files; reject unresolved names with diagnostics. Forbid same-name symbol duplicates within a file regardless of kind. Emit a warning for unused `imports` namespaces. Add IR tests covering local refs, imported refs, unused-import warnings, and unresolved symbol diagnostics. | Verify: `pytest tests/unit_tests/ir -v` | Links: scratchpad `agents/scratchpads/T-063_import_name_resolution.md`.
- T-054 | Status: Backlog | Owner: Executor | DoD: Define multi-file import/dependency spec (syntax, resolution rules, cycles, diagnostics). Capture proposed schema and pass boundaries in `docs/specs/` plus a migration note for MVP pipeline. | Verify: none | Links: scratchpad `agents/scratchpads/T-054_imports_spec.md`.
- T-055 | Status: Backlog | Owner: Architect | DoD: Reconcile `docs/specs/` with the MVP pipeline (AST -> NFIR -> IFIR -> emit), deprecate CIR/NLIR or merge into IFIR in spec docs, and update `spec_compiler_stack.md` accordingly. | Verify: none | Links: scratchpad `agents/scratchpads/T-055_specs_reconciliation.md`.
- T-056 | Status: Backlog | Owner: Executor | DoD: Add `exports` sugar to AST and lowering: allow `exports` block in modules and forward child ports into parent nets per `docs/specs/spec_ast.md`. Include diagnostics for invalid forwarding; no changes to IFIR semantics beyond expanded nets. | Verify: `pytest tests/unit_tests/ast -v && pytest tests/unit_tests/ir -v` | Links: scratchpad `agents/scratchpads/T-056_exports_sugar.md`.

## Exploration candidates (informal)
- IFIR diagnostics spans: mapping strategy, edge cases, and test fixtures.
- CLI pipeline UX: command flow, error messaging, and file layout.
- Netlist emission validation: strictness vs warnings; validation stages.
- xDSL pipeline boundaries: pass split/merge opportunities and IR boundaries.
- Codebase map gaps: navigation audit for future Executors.

## Done
- T-048 | Status: Done | Owner: Architect | DoD: Replace ngspice-specific emitter with unified netlist emitter (new module/package). Remove `emit_ngspice` and `src/asdl/emit/ngspice.py` entirely; update `src/asdl/emit/__init__.py` and all call sites/tests. Add dedicated netlist verification pass under `src/asdl/emit/` (xDSL ModulePass) and run it before lowering/rendering. Add CLI `--backend` (default `sim.ngspice`) and drive output extension from `config/backends.yaml` per-backend `extension` key (verbatim). Update backend config schema to `extension`, `comment_prefix`, `templates`; adjust loader/tests accordingly. Ensure top module emits no wrapper when `top_as_subckt` is false. Update specs and rebaseline netlist tests to new backend naming. | Verify: `pytest tests/unit_tests/emit -v && pytest tests/unit_tests/netlist -v && pytest tests/unit_tests/cli -v && pytest tests/unit_tests/e2e -v` | Links: scratchpad `agents/scratchpads/T-048_unified_netlist_emitter.md`.
- T-049 | Status: Done | Owner: Executor | DoD: Refactor `src/asdl/emit/netlist.py` into a package with clear separation of validation vs rendering. Create `src/asdl/emit/netlist/` modules: `__init__.py` (re-exports), `api.py` (emit_netlist/load_backend orchestration), `verify.py` (VerifyNetlistPass + verification runner), `render.py` (emit_design/module/instance + system device rendering), `templates.py` (placeholder parsing/validation + system-device placeholder rules/constants), `params.py` (param merge + attr stringify helpers), `ir_utils.py` (collect ops, resolve top, find single design), `diagnostics.py` (diagnostic codes + helpers). Preserve public API: `from asdl.emit.netlist import EmitOptions, VerifyNetlistPass, emit_netlist, load_backend` remains valid via re-exports. Ensure no behavior changes (byte-for-byte netlist output + diagnostics) beyond necessary import paths. Update imports across `src/asdl/emit/`, `src/asdl/cli/`, and tests as needed. Add/adjust any internal imports to avoid cycles. Update `agents/context/codebase_map.md` emission section to reflect new netlist package layout. | Verify: `pytest tests/unit_tests/emit -v && pytest tests/unit_tests/netlist -v && pytest tests/unit_tests/cli -v && pytest tests/unit_tests/e2e -v` | Links: scratchpad `agents/scratchpads/T-049_netlist_emitter_refactor.md`, PR https://github.com/Jianxun/ASDL/pull/41.
- T-047 | Status: Done | Owner: Executor | DoD: Refactor ngspice emitter to use backend config with system devices per ADR-0006. Create `src/asdl/emit/backend_config.py` with backend config loading/validation. Create `config/backends.yaml` with ngspice system device definitions (include required `__netlist_header__`/`__netlist_footer__`). Refactor `src/asdl/emit/ngspice.py` to use system device templates for subcircuit headers/footers (top uses `__subckt_*` when `top_as_subckt`, otherwise no wrapper), subcircuit calls, and required netlist headers/footers. Remove hardcoded ngspice syntax (`_format_subckt_line`, inline header/footer strings, hardcoded `X{name}...` logic). Add unit tests for backend config loading and system device rendering. Verify all existing netlist tests pass with byte-for-byte identical output. | Verify: `pytest tests/unit_tests/emit -v && pytest tests/unit_tests/netlist -v` | Links: scratchpad `agents/scratchpads/T-047_system_devices.md`, ADR-0006 `agents/adr/ADR-0006-system-devices.md`, spec `docs/specs_mvp/spec_netlist_emission_mvp.md`, PR https://github.com/Jianxun/ASDL/pull/39. | Files: `src/asdl/emit/backend_config.py`, `src/asdl/emit/ngspice.py`, `config/backends.yaml`, `tests/unit_tests/emit/test_backend_config.py`.
- T-046 | Status: Done | Owner: Architect | DoD: Expose individual merged parameter values as template placeholders in the ngspice emitter. After merging device/backend/instance params, add each key-value pair from the merged dict to `template_values` (not just the formatted `params_str`). This allows templates to reference individual params like `{L}`, `{W}`, `{NF}`, `{m}`. Preserve backward compat with `{params}` placeholder for the formatted string. | Verify: `pytest tests/unit_tests/netlist`. | Links: scratchpad `agents/scratchpads/T-046_individual_param_placeholders.md`, PR https://github.com/Jianxun/ASDL/pull/38. | Files: `src/asdl/emit/ngspice.py`.
- T-038 | Status: Done | Owner: Executor | DoD: Update netlist template placeholders to use `{ports}` (hard switch; remove `{conns}`); treat `{ports}` as optional; only implicit placeholders are `{name}` and `{ports}` (others are user-controlled). Deprecate `{params}` placeholder and remove reserved-status enforcement; update validation rules/diagnostics and tests (missing `{ports}` allowed; unknown placeholders error). Update CLI help text to list supported placeholders. | Verify: `pytest tests/unit_tests/netlist` and `pytest tests/unit_tests/cli`. | Links: scratchpad `agents/scratchpads/T-038_template_placeholders.md`, PR https://github.com/Jianxun/ASDL/pull/36.
