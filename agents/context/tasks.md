# Tasks

## Active OKR(s)
- See `agents/context/okrs.md`.

## Current Sprint
- T-048 | Status: In Progress | Owner: Architect | DoD: Replace ngspice-specific emitter with unified netlist emitter (new module/package). Remove `emit_ngspice` and `src/asdl/emit/ngspice.py` entirely; update `src/asdl/emit/__init__.py` and all call sites/tests. Add dedicated netlist verification pass under `src/asdl/emit/` (xDSL ModulePass) and run it before lowering/rendering. Add CLI `--backend` (default `sim.ngspice`) and drive output extension from `config/backends.yaml` per-backend `extension` key (verbatim). Update backend config schema to `extension`, `comment_prefix`, `templates`; adjust loader/tests accordingly. Ensure top module emits no wrapper when `top_as_subckt` is false. Update specs and rebaseline netlist tests to new backend naming. | Verify: `pytest tests/unit_tests/emit -v && pytest tests/unit_tests/netlist -v && pytest tests/unit_tests/cli -v && pytest tests/unit_tests/e2e -v` | Links: scratchpad `agents/scratchpads/T-048_unified_netlist_emitter.md`.

## Backlog

## Exploration candidates (informal)
- IFIR diagnostics spans: mapping strategy, edge cases, and test fixtures.
- CLI pipeline UX: command flow, error messaging, and file layout.
- Netlist emission validation: strictness vs warnings; validation stages.
- xDSL pipeline boundaries: pass split/merge opportunities and IR boundaries.
- Codebase map gaps: navigation audit for future Executors.

## Done
- T-049 | Status: Done | Owner: Executor | DoD: Refactor `src/asdl/emit/netlist.py` into a package with clear separation of validation vs rendering. Create `src/asdl/emit/netlist/` modules: `__init__.py` (re-exports), `api.py` (emit_netlist/load_backend orchestration), `verify.py` (VerifyNetlistPass + verification runner), `render.py` (emit_design/module/instance + system device rendering), `templates.py` (placeholder parsing/validation + system-device placeholder rules/constants), `params.py` (param merge + attr stringify helpers), `ir_utils.py` (collect ops, resolve top, find single design), `diagnostics.py` (diagnostic codes + helpers). Preserve public API: `from asdl.emit.netlist import EmitOptions, VerifyNetlistPass, emit_netlist, load_backend` remains valid via re-exports. Ensure no behavior changes (byte-for-byte netlist output + diagnostics) beyond necessary import paths. Update imports across `src/asdl/emit/`, `src/asdl/cli/`, and tests as needed. Add/adjust any internal imports to avoid cycles. Update `agents/context/codebase_map.md` emission section to reflect new netlist package layout. | Verify: `pytest tests/unit_tests/emit -v && pytest tests/unit_tests/netlist -v && pytest tests/unit_tests/cli -v && pytest tests/unit_tests/e2e -v` | Links: scratchpad `agents/scratchpads/T-049_netlist_emitter_refactor.md`, PR https://github.com/Jianxun/ASDL/pull/41.
- T-047 | Status: Done | Owner: Executor | DoD: Refactor ngspice emitter to use backend config with system devices per ADR-0006. Create `src/asdl/emit/backend_config.py` with backend config loading/validation. Create `config/backends.yaml` with ngspice system device definitions (include required `__netlist_header__`/`__netlist_footer__`). Refactor `src/asdl/emit/ngspice.py` to use system device templates for subcircuit headers/footers (top uses `__subckt_*` when `top_as_subckt`, otherwise no wrapper), subcircuit calls, and required netlist headers/footers. Remove hardcoded ngspice syntax (`_format_subckt_line`, inline header/footer strings, hardcoded `X{name}...` logic). Add unit tests for backend config loading and system device rendering. Verify all existing netlist tests pass with byte-for-byte identical output. | Verify: `pytest tests/unit_tests/emit -v && pytest tests/unit_tests/netlist -v` | Links: scratchpad `agents/scratchpads/T-047_system_devices.md`, ADR-0006 `agents/adr/ADR-0006-system-devices.md`, spec `docs/specs_mvp/spec_netlist_emission_mvp.md`, PR https://github.com/Jianxun/ASDL/pull/39. | Files: `src/asdl/emit/backend_config.py`, `src/asdl/emit/ngspice.py`, `config/backends.yaml`, `tests/unit_tests/emit/test_backend_config.py`.
- T-046 | Status: Done | Owner: Architect | DoD: Expose individual merged parameter values as template placeholders in the ngspice emitter. After merging device/backend/instance params, add each key-value pair from the merged dict to `template_values` (not just the formatted `params_str`). This allows templates to reference individual params like `{L}`, `{W}`, `{NF}`, `{m}`. Preserve backward compat with `{params}` placeholder for the formatted string. | Verify: `pytest tests/unit_tests/netlist`. | Links: scratchpad `agents/scratchpads/T-046_individual_param_placeholders.md`, PR https://github.com/Jianxun/ASDL/pull/38. | Files: `src/asdl/emit/ngspice.py`.
- T-035 | Status: Done | Owner: Executor | DoD: Decide how to map NFIR `src`/AST locations into IFIR conversion diagnostics; emit span-aware diagnostics (or document why spans are unavailable) for NFIR->IFIR conversion + emission errors; update unit tests as needed. | Verify: `pytest tests/unit_tests/ir`. | Links: scratchpad `agents/scratchpads/T-035_ifir_diagnostics_spans.md`, PR https://github.com/Jianxun/ASDL/pull/35.
- T-038 | Status: Done | Owner: Executor | DoD: Update netlist template placeholders to use `{ports}` (hard switch; remove `{conns}`); treat `{ports}` as optional; only implicit placeholders are `{name}` and `{ports}` (others are user-controlled). Deprecate `{params}` placeholder and remove reserved-status enforcement; update validation rules/diagnostics and tests (missing `{ports}` allowed; unknown placeholders error). Update CLI help text to list supported placeholders. | Verify: `pytest tests/unit_tests/netlist` and `pytest tests/unit_tests/cli`. | Links: scratchpad `agents/scratchpads/T-038_template_placeholders.md`, PR https://github.com/Jianxun/ASDL/pull/36.
- T-039 | Status: Done | Owner: Executor | DoD: Improve `asdlc --help` so the top-level menu lists `netlist` and includes a brief command summary; add a CLI help test that asserts the command list appears. | Verify: `pytest tests/unit_tests/cli`. | Links: scratchpad `agents/scratchpads/T-039_cli_help.md`, PR https://github.com/Jianxun/ASDL/pull/37.
- T-041 | Status: Done | Owner: Executor | DoD: Make `DeviceDecl.ports` optional in the AST schema; update validations/converters/tests to accept devices with no ports; confirm emission behavior for portless devices. | Verify: `pytest tests/unit_tests/ast` and `pytest tests/unit_tests/ir`. | Links: scratchpad `agents/scratchpads/T-041_device_ports_optional.md`, PR https://github.com/Jianxun/ASDL/pull/34.
- T-043 | Status: Done | Owner: Executor | DoD: Implement list-only endpoint authoring (disallow string endpoint lists) per ADR-0005; update AST schema, parser validation, and converters; update diagnostics to guide users; adjust tests. | Verify: `pytest tests/unit_tests/parser` and `pytest tests/unit_tests/ir`. | Links: scratchpad `agents/scratchpads/T-043_endpoint_list_lists_only.md`, PR https://github.com/Jianxun/ASDL/pull/32.
- T-037 | Status: Done | Owner: Executor | DoD: Update PARSE-003 diagnostics after list-only endpoint authoring lands (T-043). Ensure errors explicitly say endpoint lists must be YAML lists of `<instance>.<pin>` strings; keep instance expr hints for `<model> key=value ...`. Add parser tests for the improved message/notes. | Verify: `pytest tests/unit_tests/parser`. | Links: scratchpad `agents/scratchpads/T-037_parser_endpoint_hints.md`, PR https://github.com/Jianxun/ASDL/pull/33.
- T-036 | Status: Done | Owner: Executor | DoD: Implement CLI command under `src/asdl/cli/` that runs the MVP pipeline end-to-end via `src/asdl/ir/pipeline.py` and emits ngspice output (no direct converter calls); expose `--verify` toggle, deterministic diagnostics, and default output `{asdl_basename}.spice`; add CLI-level tests. Blocked on T-034 completion. | Verify: `pytest tests/unit_tests/cli`. | Links: scratchpad `agents/scratchpads/T-036_cli_pipeline.md`, PR https://github.com/Jianxun/ASDL/pull/31.
- T-045 | Status: Done | Owner: Architect | DoD: Update AST specs (`docs/specs_mvp/spec_ast_mvp.md`, `docs/specs/spec_ast.md`) to make `DeviceDecl.ports` optional and reflect list-only endpoint lists per ADR-0005. | Verify: none (doc task). | Links: scratchpad `agents/scratchpads/T-045_ast_specs_updates.md`.
