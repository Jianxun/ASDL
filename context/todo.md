# Project Todo List

## Current Sprint - Validation & Quality Enhancements

### ğŸ‰ **CRITICAL PARAMETER PROPAGATION BUG FIX COMPLETED âœ…**
- [X] **Critical Module Instance Parameter Propagation Bug Fix** âœ…
  - [X] Identified missing parameter propagation in `_generate_subckt_call()` method âœ…
  - [X] Enhanced method to match device instance parameter handling âœ…
  - [X] Maintained backward compatibility for instances without parameters âœ…
  - [X] Verified fix with real-world `two_stage_ota.yml` example âœ…
  - [X] Confirmed all 48 existing generator tests still pass âœ…
  - [X] Updated method documentation to reflect parameter support âœ…
  - [X] Regenerated example SPICE files with correct parameter propagation âœ…

**Critical Achievement**: Module instances now correctly pass parameters to subcircuit calls in SPICE output. The `two_stage_ota` example now generates `X_FIRST_STAGE ... M={M_first_stage}` instead of missing the parameter entirely. This fixes a fundamental bug that broke hierarchical parameterization in complex analog designs.

### ğŸ‰ **NET DECLARATION VALIDATION COMPLETED âœ…**
- [X] **Net Declaration Validation Feature** âœ…
  - [X] Implement validation for undeclared nets in instance mappings âœ…
  - [X] Handle pattern expansion validation (`out_<p,n>` â†’ `out_p`, `out_n`) âœ…
  - [X] Generate non-breaking warnings for undeclared nets âœ…
  - [X] Integrate with existing warning system âœ…
  - [X] Create comprehensive test suite (6 test cases) âœ…
  - [X] Test real-world scenario (ota_5t module issue) âœ…
  - [X] Verify backward compatibility with existing tests âœ…
  - [X] Update context documentation âœ…

**Technical Achievement**: SPICEGenerator now provides intelligent connectivity validation that catches undeclared nets while maintaining robust netlisting functionality. This addresses the specific issue identified in `two_stage_ota.yml` where `out_n` and `out_<p,n>` nets were used but not declared.

### ğŸ‰ **CRITICAL PATTERN EXPANSION BUG FIX COMPLETED âœ…**
- [X] **Major Circuit Correctness Bug Fix** âœ…
  - [X] Identified critical bug in one-sided net pattern expansion âœ…
  - [X] Fixed `_expand_mapping_patterns` to use `instance_index` for net patterns âœ…
  - [X] Verified differential pairs now connect correctly (`MN_Pâ†’in_p`, `MN_Nâ†’in_n`) âœ…
  - [X] Added comprehensive test coverage using `diff_pair_nmos.yml` fixture âœ…
  - [X] Created `TestRealWorldDifferentialPair` class with 3 test methods âœ…
  - [X] Fixed failing test expectation to match correct behavior âœ…
  - [X] Verified all 51 expander tests pass âœ…

**Critical Achievement**: Fixed bug that completely broke differential amplifier functionality. Pattern expansion now correctly routes signals to differential pairs and other multi-instance circuits.

### ğŸ‰ **PORT ORDER CANONICAL COMPLIANCE COMPLETED âœ…**
- [X] **Critical Bug Fix: SPICE Port Order** âœ…
  - [X] Identified alphabetical sorting bug in `_get_port_list()` method âœ…
  - [X] Fixed generator to preserve YAML declaration order instead of sorting âœ…
  - [X] Validated that pattern expansion preserves correct order (`in_<p,n>` â†’ `["in_p", "in_n"]`) âœ…
  - [X] Updated test expectations to match canonical YAML order âœ…
  - [X] Verified all 42 generator tests pass with corrected port order âœ…
  - [X] Regenerated example SPICE files with correct port order âœ…

**Technical Achievement**: SPICE `.subckt` declarations now follow the canonical order defined in the ASDL YAML `ports:` section, ensuring consistency and predictability across all generated netlists.

### ğŸ‰ **UNUSED COMPONENT VALIDATION COMPLETED âœ…**
- [X] **Core Unused Validation Feature** âœ…
  - [X] Implement usage tracking for models and modules âœ…
  - [X] Add recursive hierarchy analysis from top module âœ…
  - [X] Generate warnings for unused components without breaking netlisting âœ…
  - [X] Integrate with existing warning system âœ…
  - [X] Create comprehensive test suite (5 test cases) âœ…
  - [X] Verify backward compatibility with existing generator tests âœ…
  - [X] Demonstrate feature with real-world examples âœ…

**Technical Achievement**: SPICEGenerator now provides intelligent validation that helps developers identify dead code while maintaining robust netlisting functionality.

## Current Sprint: **THOROUGH DATA STRUCTURE REFACTOR âœ… COMPLETE**

### **ğŸ‰ COMPLETE LEGACY REMOVAL & ARCHITECTURE CLEANUP âœ…**
- [X] **Phase 1: PrimitiveType Enum** âœ…
  - [X] âŒ **REMOVED** legacy DeviceType enum completely âœ…
  - [X] âœ… **ADDED** clean PrimitiveType enum (PDK_DEVICE vs SPICE_DEVICE) âœ…
  - [X] Comprehensive test coverage: 8/8 tests passing âœ…

- [X] **Phase 2: Universal Metadata Field** âœ…
  - [X] âœ… **ADDED** metadata field to ALL structures: ASDLFile, FileInfo, DeviceModel, Port, Module, Instance âœ…
  - [X] âŒ **REMOVED** Instance intent field (replaced with metadata) âœ…
  - [X] Comprehensive test coverage: 9/9 tests passing âœ…

- [X] **Phase 3: Internal Nets Field** âœ…
  - [X] âŒ **REMOVED** complex Nets class entirely âœ…
  - [X] âœ… **REPLACED** with simple internal_nets: List[str] on Module âœ…
  - [X] Comprehensive test coverage: 9/9 tests passing âœ…

- [X] **Phase 4: Simplified DeviceModel** âœ…
  - [X] âŒ **REMOVED** legacy fields (model, params, description) âœ…
  - [X] âŒ **REMOVED** backward compatibility methods âœ…
  - [X] âœ… **REQUIRED** device_line field (now non-optional) âœ…
  - [X] Comprehensive test coverage: 8/8 tests passing âœ…

- [X] **Phase 5: Serialization Separation** âœ…
  - [X] âŒ **REMOVED** all serialization methods from ASDLFile âœ…
  - [X] âœ… **CREATED** dedicated src/asdl/serialization.py module âœ…
  - [X] Clean separation of data structures and I/O logic âœ…

**ğŸ¯ PRODUCTION READY**: Clean architecture, 34/34 data structure tests passing âœ…

## Next Sprint: Linter & Compiler Architecture Refactoring
- [X] **Phase 1: Parser Refactoring** âœ…
  - [X] Rewrite parser to be pure, non-validating âœ…
  - [X] Integrate `ruamel.yaml` for location tracking âœ…
  - [X] Rewrite parser test suite using TDD âœ…
  - [X] Implement location tracking for `FileInfo` âœ…
- [X] **Phase 2: Full Location Tracking** âœ…
  - [X] Add `Locatable` base class to all relevant data structures (`DeviceModel`, `Module`, `Port`, `Instance`). âœ…
  - [X] Update parser to populate location data for all structures. âœ…
  - [X] Update tests to assert correct location data for all structures. âœ…
- [X] **Phase 3: Foundation** âœ…
  - [X] Create shared `Diagnostic` data structures (`src/asdl/diagnostics.py`) âœ…
  - [X] Create tests for diagnostic data structures âœ…
- [X] **Phase 4: Diagnostic System Foundation** âœ…
  - [X] Defined structured diagnostic codes for Parser, Elaborator, and Validator. âœ…
  - [X] Created `doc/diagnostic_codes.md` to document all codes, their status, and test coverage. âœ…
  - [X] Refactored `Diagnostic` data class to support structured data (`code`, `title`, `details`, `suggestion`). âœ…
- [ ] **Phase 5: Elaboration & Analysis Pipeline**
  - [X] **Step 1: Create the `Elaborator` Foundation** âœ…
    - [X] Create new file `src/asdl/elaborator.py` with the `Elaborator` class skeleton. âœ…
    - [X] Create new test suite `tests/unit_tests/elaborator/`. âœ…
    - [X] Document the design plan in `doc/elaborator_design_plan.md`. âœ…
  - [X] **Step 2: Migrate Pattern Expansion (TDD)** âœ…
    - [X] Incrementally move pattern expansion logic from `PatternExpander` to `Elaborator`. âœ…
    - [X] Refactor all `ValueError` exceptions to `Diagnostic` reports. âœ…
    - [X] Ensure all new logic is covered by tests in the new test suite. âœ…
  - [ ] **Step 3: Implement Parameter Resolution (TDD)**
    - [ ] Add logic to the `Elaborator` to resolve and substitute parameter values.
    - [ ] Create tests for parameter resolution, including error cases (e.g., undefined parameters).
  - [ ] **Step 4: Implement Bus Pattern Expansion (TDD)**
    - [ ] Implement robust `_has_bus_pattern` detection logic.
    - [ ] Add `_expand_bus_pattern` method to handle range-based expansion (e.g., `[3:0]`).
    - [ ] Create tests for bus pattern expansion, including error cases.
  - [ ] **Step 5: Deprecate Old Code**
    - [ ] Delete `src/asdl/expander.py` and its associated tests.
    - [ ] Remove parameter resolution logic from `SPICEGenerator`.
  - [ ] Create new `Validator` module (`src/asdl/validator.py`)
- [ ] **Phase 5: Tooling Back-Ends**
  - [ ] Create Linter entry point script (`scripts/asdl_linter.py`)
  - [ ] Update compiler pipeline to use the new `Validator`

## Backlog: Advanced Validation & User Experience

### **Testing & Refinements**
- [ ] Thoroughly test `serialization.py` module

### **Enhanced Validation Features** (NEW PRIORITY)
- [ ] **Cross-Reference Validation**
  - [ ] Detect and warn about circular dependencies between modules
  - [ ] Validate parameter references (undefined parameters used)
  - [ ] Check for orphaned nets (declared but never connected)
  - [ ] Validate port width consistency in pattern expansions
- [ ] **Design Rule Checking (DRC)**
  - [ ] Basic electrical rules (no floating inputs/outputs)
  - [ ] Port direction consistency checking
  - [ ] Parameter range validation
  - [ ] Device constraint validation (W/L ratios, etc.)

### **User Experience Enhancements**
- [ ] **Improved Error Messages**
  - [ ] Line number references in YAML files for errors/warnings
  - [ ] Suggestion system for common mistakes
  - [ ] Context-aware error descriptions
  - [ ] Color-coded warning levels (info, warning, error)
- [ ] **Documentation Generation**
  - [ ] Auto-generate circuit documentation from ASDL designs
  - [ ] HTML documentation with cross-references
  - [ ] Dependency graphs and usage maps
  - [ ] Parameter sensitivity analysis

## PHASE 5: Pattern Expansion & Advanced Features (COMPLETED)

### ğŸ‰ **PHASE 5 COMPLETED âœ…** (Pattern Expansion & Advanced Features + Test Expectation Updates)
**PERFECT TEST STATUS ACHIEVED**: 131/131 tests passing âœ…

### ğŸ‰ **TEST EXPECTATION REFACTORING COMPLETED âœ…**
- [X] **Complete Test Architecture Update** âœ…
  - [X] Updated device generation tests to expect hierarchical subcircuits âœ…
  - [X] Updated pipeline tests to expect real PDK device names (nfet_03v3, pfet_03v3) âœ…
  - [X] Created missing test fixture (inverter_reordered.yml) âœ…
  - [X] Updated PySpice tests to handle complex PDK parameter limitations âœ…
  - [X] Removed all legacy test expectations (pre-release refactoring) âœ…
  - [X] **Result**: 11 test failures â†’ 0 test failures (126/126 passing) âœ…

**âœ… Pre-Release Achievement**: All tests now validate the current hierarchical subcircuit architecture

### ğŸ‰ **PATTERN EXPANSION SYSTEM COMPLETED âœ…**
- [X] **Pattern Expansion Rules Documentation** âœ…
  - [X] Documented comprehensive literal expansion rules in `doc/pattern_expansion_rules.md` âœ…
  - [X] Defined error conditions and validation rules âœ…
  - [X] Clarified instance expansion behavior (separate instantiations) âœ…
- [X] **CRITICAL MAPPING FORMAT CORRECTION** âœ…
  - [X] Identified incorrect mapping format: `G_<p,n>: in_<p,n>` â†’ `G: in_<p,n>` âœ…
  - [X] Updated ASDL_schema documentation to show correct format âœ…
  - [X] Fixed all examples in schema and example files âœ…
  - [X] Recorded lesson learned in memory.md âœ…
- [X] **SCHEMA v0.5 REFINEMENT & LANGUAGE DOCUMENTATION** âœ…
  - [X] Created clean, concise ASDL_schema_v0p5 structure âœ…
  - [X] Developed comprehensive language.md with semantic rules âœ…
  - [X] Codified "Expansion only on RHS" mapping rule âœ…
  - [X] Defined best practices and future extensions âœ…
  - [X] Validated mapping lesson learned in official documentation âœ…
- [X] **Pattern Expansion System Implementation** âœ…
  - [X] **Step 1: Pattern Parsing & Validation Tests + Implementation** âœ…
    - [X] Write tests for pattern detection (`_has_literal_pattern`) âœ…
    - [X] Write tests for pattern extraction (`_extract_literal_pattern`) âœ…
    - [X] Write tests for pattern validation (item counts, emptiness) âœ…
    - [X] Implement pattern parsing methods âœ…
  - [X] **Step 2: Basic Literal Expansion Tests + Implementation** âœ…
    - [X] Write tests for port pattern expansion integration âœ…
    - [X] Write tests for mapping pattern expansion (order-sensitive) âœ…
    - [X] Write tests for one-sided pattern expansion âœ…
    - [X] Implement `expand_port_patterns` method with literal pattern support âœ…
    - [X] Implement `_expand_mapping_patterns` method with full pattern support âœ…
  - [X] **Step 3: Instance Expansion Tests + Implementation** âœ… 
    - [X] Write tests for instance name expansion âœ…
    - [X] Write tests for synchronized instance+mapping expansion âœ…
    - [X] Write tests for separate instantiation behavior âœ…
    - [X] Implement `expand_instance_patterns` method âœ…
  - [X] **Step 4: Instance Documentation & Schema Robustness** âœ…
    - [X] Added `doc` field as first-class citizen for instances âœ…
    - [X] Fixed Pattern Expander to preserve `doc` field during expansion âœ…
    - [X] Replaced manual field copying with `dataclasses.replace()` for future-proofing âœ…
    - [X] Created 7 comprehensive documentation tests âœ…
    - [X] Created 6 schema robustness tests âœ…
    - [X] Fixed module parameter generation (`.param` declarations) âœ…
    - [X] Fixed instance naming consistency (`X_{name}` format) âœ…
    - [X] Fixed NoneType parameter handling âœ…
  - [X] **Step 5: Test Expectation Updates & Architecture Validation** âœ…
    - [X] Updated all test expectations to match hierarchical subcircuit architecture âœ…
    - [X] Removed legacy support expectations (pre-release refactoring) âœ…
    - [X] Created missing test fixtures âœ…
    - [X] Fixed PySpice integration test limitations âœ…
    - [X] Achieved perfect test status (126/126 passing) âœ…

**âœ… Key Achievement This Phase**: Complete pattern expansion system with perfect test validation

## Completed Tasks

### **Phase 5: Advanced Features (COMPLETE)**
- [X] **Unused Component Validation** âœ…
  - [X] Hierarchical usage tracking from top module âœ…
  - [X] Warning generation for unused models and modules âœ…
  - [X] Non-breaking validation that preserves netlisting âœ…
  - [X] Comprehensive test coverage (5 scenarios) âœ…
  - [X] Integration with existing warning system âœ…
  - [X] Backward compatibility maintained âœ…

### **PHASE 4 COMPLETED âœ…** (ngspice Simulation Testing & User Workflow Validation)
**PERFECT USER WORKFLOW ACHIEVED**:

**âœ… Ideal User Workflow Validated:**
1. User creates device in xschem schematic âœ…
2. User adjusts device size in xschem âœ…
3. User netlists the schematic âœ…
4. User copies device line exactly to ASDL YAML `device_line` âœ…
5. ASDL preserves expressions exactly as-is âœ…
6. ngspice simulates perfectly with ZERO manual intervention âœ…

**âœ… Technical Achievements:**
- [X] **Devcontainer Enhancement** âœ…
  - [X] Full repository mounted at `/foss/asdl` with EDA tools properly configured âœ…
  - [X] ngspice accessible and working correctly âœ…
  - [X] Concurrent access to ASDL codebase and EDA tool environment âœ…

- [X] **PDK Integration Perfection** âœ…
  - [X] GF180MCU PDK models (`nfet_03v3`, `pfet_03v3`) working correctly âœ…
  - [X] Complex device lines with expressions work exactly as-is from xschem âœ…
  - [X] ngspice automatically resolves `ad='int((nf+1)/2) * W/nf * 0.18u'` using hard-coded values âœ…

- [X] **Complete Simulation Validation** âœ…
  - [X] Operating Point Analysis âœ…
  - [X] DC Transfer Characteristic âœ…
  - [X] Switching Transient Analysis âœ…
  - [X] AC Small-Signal Response âœ…
  - [X] Propagation Delay Measurement âœ…
  - [X] Load Capacitance Analysis âœ…

**âœ… Key Discovery**: ngspice is smarter than expected - it automatically resolves complex expressions using hard-coded parameter values from the same device line, eliminating the need for manual parameter extraction or expression flattening.

### ğŸ‰ **PORT MAPPING VALIDATION BUG FIX COMPLETED âœ…** (CRITICAL QUALITY IMPROVEMENT)
**SILENT FAILURE ELIMINATED**: Port mapping validation now catches inconsistencies that were previously ignored âœ…

## Setup & Planning âœ… COMPLETED
- [X] Setup context management files
- [X] Analyze ASDL schema v0.4 structure
- [X] Review architecture decisions with user
- [X] Update schema field name from `design_info` to `file_info`
- [X] Implement basic Python class definitions and data structures
- [X] Define interfaces between parser, resolver, and generator
- [X] Create detailed implementation plan
- [X] Update implementation plan with current sprint status

## Development Environment âœ… COMPLETED
- [X] Verify virtual environment setup
- [X] Install/verify all dependencies
- [X] Setup development tools (black, flake8, pytest)
- [X] Create initial source code structure

## Current Sprint
- [ ] **Refactor Core Data Structures**: Implement the changes outlined in `doc/data_structure_design.md` and recorded in `context/memory.md`.
  - [ ] Move serialization logic from `data_structures.py` to a new `serialization.py` file.
  - [ ] Refactor `DeviceModel` and `DeviceType`.
  - [ ] Replace `Nets` class with `internal_nets` on `Module`.
  - [ ] Add the universal `metadata` field to all relevant classes.

## Backlog
[List of tasks for future sprints]

## Completed Tasks
[List of completed tasks] 