file_info:
  top_module: two_stage_ota
  doc: "Two-stage Miller-compensated operational transconductance amplifier"
  revision: "v0.4"
  author: "ASDL"
  date: "2025-06-14"

models:
  jumper:
    doc: "Small resistor net jumper"
    type: spice_device
    ports: [plus, minus]
    device_line: |
      R1 {plus} {minus} R=100m

  nmos_unit:
    doc: "NMOS transistor unit cell"
    type: pdk_device
    ports: [G, D, S, B]
    device_line: |
      MN {D} {G} {S} {B} nfet_03v3 L=0.5u W=4u nf=2 ad='int((nf+1)/2) * W/nf * 0.18u' as='int((nf+2)/2) * W/nf * 0.18u' pd='2*int((nf+1)/2) * (W/nf + 0.18u)' ps='2*int((nf+2)/2) * (W/nf + 0.18u)' nrd='0.18u / W' nrs='0.18u / W' sa=0 sb=0 sd=0
    parameters:
      M: 1

  pmos_unit:
    doc: "PMOS transistor unit cell"
    type: pdk_device
    ports: [G, D, S, B]
    device_line: |
      MP {D} {G} {S} {B} pfet_03v3 L=0.5u W=4u nf=2 ad='int((nf+1)/2) * W/nf * 0.18u' as='int((nf+2)/2) * W/nf * 0.18u' pd='2*int((nf+1)/2) * (W/nf + 0.18u)' ps='2*int((nf+2)/2) * (W/nf + 0.18u)' nrd='0.18u / W' nrs='0.18u / W' sa=0 sb=0 sd=0
    parameters:
      M: 1

  comp_cap:
    doc: "Miller compensation capacitor"
    type: spice_device
    ports: [plus, minus]
    device_line: | 
      C1 {plus} {minus} C=1p

  comp_res:
    doc: "Miller compensation resistor"
    type: spice_device
    ports: [plus, minus]
    device_line: |
      R1 {plus} {minus} R=1k

modules:
  bias_gen:
    doc: "Bias generator"
    ports:
      ibias: {dir: in, type: current}
      vbn: {dir: out, type: voltage}
      vss: {dir: in_out, type: voltage}
      vdd: {dir: in_out, type: voltage, constraints: {Vdd: 1.8}}
    instances:
      MN_BIAS:
        model: nmos_unit
        mappings: {G: vbn, D: vbn, S: vss, B: vss}
        parameters:
          M: 1
        intent:
          op:
            region: saturation
      J1:
        model: jumper
        mappings: {plus: ibias, minus: vbn}


  ota_5t:
    doc: "5-transistor OTA: differential pair with current mirror load"
    ports:
      in_<p,n>:  {dir: in,  type: voltage, constraints: {common_mode: 0.6}}
      out:       {dir: out, type: voltage}
      vbn:       {dir: in,  type: voltage}
      vss:       {dir: in_out, type: voltage}
      vdd:       {dir: in_out, type: voltage, constraints: {Vdd: 1.8}}
    nets:
      internal: [tail, vd]
    parameters:
      M: 2
    instances:
      MN_<P,N>:
        doc: "NMOS input transistors"
        model: nmos_unit
        mappings:
          G: in_<p,n>
          D: <vd,out>
          S: tail
          B: vss
        parameters:
          M: "{M}"
        intent:
          op:
            region: saturation

      MN_TAIL:
        doc: "NMOS tail current source"
        model: nmos_unit
        mappings: {G: vbn, D: tail, S: vss, B: vss}
        parameters:
          M: "{M}*2"
        intent:
          op:
            region: saturation

      MP_<P,N>:
        doc: "PMOS current mirror load"
        model: pmos_unit
        mappings:
          G: vd # mirror diode on n side
          D: <vd,out>
          S: vdd
          B: vdd
        parameters:
          M: "{M}*3"
        intent:
          op:
            region: saturation

  common_source_pmos:
    doc: "Second stage: PMOS Common source amplifier with NMOS current source load"
    ports:
      in:      {dir: in,  type: voltage}
      out:     {dir: out, type: voltage}
      vbn:     {dir: in,  type: voltage}
      vss:     {dir: in_out, type: voltage}
      vdd:     {dir: in_out, type: voltage, constraints: {Vdd: 1.8}}
    parameters:
      M: 4
    instances:
      MP_CS:
        model: pmos_unit
        mappings: {G: in, D: out, S: vdd, B: vdd}
        parameters:
          M: "{M}*3"
        intent:
          op:
            region: saturation

      MN_LOAD:
        model: nmos_unit
        mappings: {G: vbn, D: out, S: vss, B: vss}
        parameters:
          M: "{M}"
        intent:
          op:
            region: saturation

  miller_comp:
    doc: "Miller compensation network"
    ports:
      plus:  {dir: in_out,  type: voltage}
      minus: {dir: in_out, type: voltage}
    nets:
      internal: [v_int]
    instances:
      CC:
        model: comp_cap
        mappings: {plus: plus, minus: v_int}

      RC:
        model: comp_res
        mappings: {plus: v_int, minus: minus}


  two_stage_ota:
    doc: "Two-stage Miller-compensated operational transconductance amplifier"
    ports:
      in_<p,n>:  {dir: in,  type: voltage, constraints: {common_mode: 0.6}}
      out:       {dir: out, type: voltage}
      ibias:     {dir: in,  type: current}
      vss:       {dir: in_out, type: voltage}
      vdd:       {dir: in_out, type: voltage, constraints: {Vdd: 1.8}}
    nets:
      internal: [first_stage_out, vbn]
    parameters:
      M_first_stage: 2
      M_second_stage: 4
    instances:
      BIAS_GEN:
        model: bias_gen
        mappings: {ibias: ibias, vbn: vbn, vss: vss, vdd: vdd}

      FIRST_STAGE:
        model: ota_5t
        mappings:
          in_<p,n>: in_<n,p> # swap port mapping to match full ota polarity
          out: first_stage_out
          vbn: vbn
          vss: vss
          vdd: vdd
        parameters:
          M: "{M_first_stage}"

      SECOND_STAGE:
        model: common_source_pmos
        mappings: 
          in: first_stage_out
          out: out
          vbn: vbn
          vss: vss
          vdd: vdd
        parameters:
          M: "{M_second_stage}"

      COMP:
        model: miller_comp
        mappings: {plus: first_stage_out, minus: out}